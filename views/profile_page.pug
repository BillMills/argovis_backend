doctype html
html(lang='en')
    head
        title=title
        meta(charset='utf-8')
        link(rel='stylesheet', href='/stylesheets/style.css')
        script(type="text/javascript", src='https://cdn.plot.ly/plotly-latest.min.js')
        link(rel='stylesheet', href='/stylesheets/external-css/bootstrap.css')
        script(src='/javascripts/external-js/FileSaver.min.js')
        script(src='/javascripts/external-js/jquery.min.js')
        script(src='/javascripts/external-js/bootstrap.min.js')
    body

    block content
        div(class='selection_and_catalog_page')
            h1 Profile Id: #{title}
            p Date: #{moment(profile.date).format("YYYY-MM-DD HH:mm")}
            p Cycle number: #{profile.cycle_number}
            p Dac: #{profile.dac}
            p Parameters: #{profile.station_parameters}
            p Positioning system: #{profile.POSITIONING_SYSTEM}
            p Platform type: #{profile.PLATFORM_TYPE}
            p Data mode: #{profile.DATA_MODE}
            p Data source:
            a(href=profile.nc_url) #{profile.nc_url}
            p
            a(href='/catalog/platforms/'+ platform_number + '/page' target='_blank') To platform #{profile.platform_number} page
            div
            a(href='/map' ) To main page
            #TPS_CHART
            button.btn.btn-primary.btn-block(type='submit', id='downloadProfiles') Download data as JSON

    script(type='text/javascript').

        $('#downloadProfiles').on('click', function(){
            var url = '/catalog/profiles/' + `#{title}`;
            window.open(url,'_blank');
        });

        function collateMeasurements(list) {
                var map = {};
            var keys = Object.keys(list[0]);
            map.pres = [];
            map.temp = [];
            map.psal = [];

            for (var i = 0; i < list.length; ++i) {
                map.pres.push(list[i].pres);
                map.temp.push(list[i].temp);
                map.psal.push(list[i].psal);
            }
            return map;
        }

        var meas = [!{profile.measurements}];
        meas = collateMeasurements(meas);

        const getEmptyIdx = function(array) {
            var indices = [];
            var element = -999;
            var idx = array.indexOf(element);
            while (idx != -1) {
                indices.push(idx);
                idx = array.indexOf(element, idx + 1);
            }
            return(indices);
        }

        //zeros signify empty values. These need to be removed from the arrays that will be used to make traces.
        var temp = meas.temp;
        var psal = meas.psal;
        //presForTemp = combinedProfiles.pres.map(function(element) { return (element * -1) }); //flipping pres axis
        presForTemp = meas.pres
        presForPsal = meas.pres; //initialize
        tempForPsal = temp;
        psalForTemp = psal;

        tempEmptyIdx = getEmptyIdx(temp);
        psalEmptyIdx = getEmptyIdx(psal);

        //drop instances from arrays where temp is -999.
        var i = tempEmptyIdx.length
        while(i--) {
            idx = tempEmptyIdx[i];
            presForTemp.splice(idx, 1, -999);
            psalForTemp.splice(idx, 1, -999); // for temp vs psal
            tempForPsal.splice(idx, 1, -999); // for temp vs psal
        }

        //drop all values of -999
        temp = temp.filter(function(value){ if (value != -999) {return(value)}})
        presForTemp = presForTemp.filter(function(value){ if (value != -999) {return(value)}})

        //drop instances from arrays where psal is -999.
        var i = psalEmptyIdx.length
        while(i--) {
            idx = psalEmptyIdx[i];
            presForPsal.splice(idx, 1, -999);
            psalForTemp.splice(idx, 1, -999); // for temp vs psal
            tempForPsal.splice(idx, 1, -999); // for temp vs psal
        }

        psal = psal.filter(function(value){ if (value != -999) {return(value)}})
        presForPsal = presForPsal.filter(function(value){ if (value != -999) {return(value)}})

        tempForPsal = tempForPsal.filter(function(value){ if (value != -999) {return(value)}})
        psalForTemp = psalForTemp.filter(function(value){ if (value != -999) {return(value)}})

        const measurements = {'temp_v_psal': {'yvalue': tempForPsal, 'xvalue': psalForTemp, 'yaxis': 'y1', 'xaxis': 'x1'},
                                'pres_v_psal': {'yvalue': presForPsal, 'xvalue': psal, 'yaxis': 'y2', 'xaxis': 'x2'},
                                'pres_v_temp': {'yvalue': presForTemp, 'xvalue': temp, 'yaxis': 'y3', 'xaxis': 'x3'}
                                };

        const makeTrace =function(key) {
            meas = measurements[key];
            return {
                y: meas.yvalue,
                x: meas.xvalue,
                xaxis: meas.xaxis,
                yaxis: meas.yaxis,
                mode: 'markers',
                type: 'scatter',
                name: key
            };
        }

        const layout = {
            title: "Profile measurements",
            autosize: false,
            height: 400, 
            width: 1200, 

            xaxis3: {
                domain: [0, 0.266],
                autorange: true,
                title: "Temperature [Celsius]"
            }, 
            xaxis2: {
                domain: [.366, 0.633],
                autorange: true,
                title: "Salinity [psi]"
            }, 
            xaxis: {
                domain: [.733, 1],
                autorange: true, 
                title: "Salinity [psi]"
            },
            yaxis3: {
                anchor: "x3",
                autorange: 'reversed', 
                type: "linear", 
                title: "Pressure [dbar]"
            },  
            yaxis2: {
                anchor: "x2",
                autorange: 'reversed',
                title: "Pressure [dbar]",
            }, 
            yaxis: {
                anchor: "x1",
                autorange: true, 
                title: "Temperature [Celsius]"
            }, 
            hovermode: "closest", 
            showlegend: false
        };
        Plotly.plot('TPS_CHART', ['pres_v_temp', 'pres_v_psal', 'temp_v_psal'].map(makeTrace), layout);